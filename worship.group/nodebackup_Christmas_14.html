<?php
	//ini_set('memory_limit', '-1');
	include($_SERVER['DOCUMENT_ROOT'] . "/scripts/Mobile_Detect.php");
	
	// Forward IE 6 and IE 7 users to video only page
	$IE6 = (strpos($_SERVER['HTTP_USER_AGENT'], 'MSIE 6') !== FALSE);
    $IE7 = (strpos($_SERVER['HTTP_USER_AGENT'], 'MSIE 7') !== FALSE);
	if (($IE6 == 1) || ($IE7 == 1)) {
		header('Location: http://northlandchurch.net/video-only'); exit();	
	}
	
	// Forward smartphone users to mobile page
	$detect = new Mobile_Detect();
	if ($detect->isMobile() && !$detect->isTablet()) {
		header('Location: http://northlandchurch.net/worship/mobile'); exit();	
	}

	// Establish chat id, use member ID if logged in, otherwise generate new one
	$member_id_reference = $this->EE->session->userdata('member_id');	
	if ($member_id_reference == 0) {
		$member_id_reference = 1;
				
		$sql="UPDATE usercounter SET counter = counter + 1";
		mysql_query($sql) or die();
		$sql = "SELECT counter FROM usercounter";
		$result = mysql_query($sql) or die();
		
		while ($row = mysql_fetch_array($result)) {
			$member_id_reference = $row['counter'];
		}
	}
	
	// IP2Location logic
	/*require_once($_SERVER['DOCUMENT_ROOT'] . "/scripts/ip2location/IP2Location.php");
	
	$ip2location = new IP2Location($_SERVER['DOCUMENT_ROOT'] . "/scripts/ip2location/IP-COUNTRY-REGION-CITY-LATITUDE-LONGITUDE.BIN", IP2Location::FILE_IO);
	
	$client_ip = $_SERVER['REMOTE_ADDR'];
	$ip2location_record = $ip2location->lookup($client_ip, IP2Location::ALL);
	
	$client_latitude = round($ip2location_record->latitude, 4);
	$client_longitude = round($ip2location_record->longitude, 4);
	
	if ($ip2location_record->countryCode == "US") {
		$client_location = ucwords(strtolower($ip2location_record->cityName)) . ", " . ucwords(strtolower($ip2location_record->regionName));
	}
	else {
		if ($ip2location_record->cityName) {
			$client_location = ucwords(strtolower($ip2location_record->cityName)) . ", " . ucwords(strtolower($ip2location_record->countryName));
		}
		else {
			$client_location = ucwords(strtolower($ip2location_record->countryName));
		}
	}*/
?>

{!-- Show if user is logged in --}

{embed="_includes/html_open_worship" htmltitle="Northland Online Worship"}
<div style="display:none">Worship online with Northland, A Church Distributed.</div>

<div id="header-bg" style="display:none">
	{embed="_includes/header-beta"}	
</div>
<meta name="viewport" content="width=970, user-scalable=no"/>

<style type="text/css">
	.custom_scrollbar::-webkit-scrollbar {
		width: 8px;
		height: 8px;
	}
	.custom_scrollbar::-webkit-scrollbar-track {
		background-color: rgba(0,0,0,0.2);
	}
	.custom_scrollbar::-webkit-scrollbar-thumb:vertical {
		background-color: rgba(0,0,0,0.6);
		-webkit-border-radius: 6px;
	}
	.custom_scrollbar::-webkit-scrollbar-thumb:vertical:hover,
	.custom_scrollbar::-webkit-scrollbar-thumb:horizontal:hover {
		background-color: rgba(0,0,0,0.8);
	}
</style>

<link rel="stylesheet" type="text/css" media="all" href="/_includes/css-onlineworship.css" />
<link rel="stylesheet" type="text/css" media="all" href="/_includes/adapt/full.css" />
<div id="friends_hide"><style></style></div>
<div id="signedin_hide"><style>.notsignedin { display: none; }</style></div>

<script type="text/javascript">
	var d = new Date();

	var rand_number = d.getTime();
	var socket = null;
	
	$(document).ready(function() {
		{if group_id == "1" || group_id == "22" || group_id == "13"}
		StartServiceLiveCheck();
		{/if}
		{if service_live != "true"}StartCheckServiceLive();{/if}
		InitializeEventHandlers();
		initiate_geolocation();
		//InitializeSlimScroll();
		//InitializeJWChatHandlers();
	});	
	
	$(window).load(function() {
		GetFriendships();
		StartMapUpdateCycle();
	});
</script>

<script type="text/javascript">
// Efficient indexOf handler if browser doesn't support natively
if (!Array.prototype.indexOf)
{
  Array.prototype.indexOf = function(elt /*, from*/)
  {
    var len = this.length;

    var from = 0;

    for (; from < len; from++)
    {
      if (from in this &&
          this[from] === elt)
        return from;
    }
    return -1;
  };
}
</script>

{!-- Adaptive textarea code --}
<script type="text/javascript" src="/_assets/js/jquery.autosize-min.js"></script>

{!-- Issuu Code --}
<script type="text/javascript">
var issuu_loaded = 0;
function LoadIssuu() {
	if (issuu_loaded == 0) {
		var html_content = '{exp:channel:entries channel="newspaper" dynamic="off" orderby="date" cache="yes" refresh="120" sort="desc" limit="1"}<iframe id="issuuiframe" src="{newspaper-embed}" width="618" height="348" frameborder=0></iframe><p style="margin:0 20px">Download a searchable PDF to read later: <a href="http://www.nacdweb.org/files/pressroom/{newspaper-pdf}" title="{title}" target="_blank">Download {title}&rsquo;s PDF.</a></p>{/exp:channel:entries}';
		
		$('#worship-tab').html(html_content);
		
		issuu_loaded = 1;
	}
}
</script>

<script type="text/javascript" src="/_js/jquery.profanityfilter.min.js"></script>

<div id="header-minimized">
	<div id="header-bar-small">
		<div class="container_12">
			<div id="header-small-left">
				<a href="http://www.northlandchurch.net" style="text-decoration: none" target="_blank"><h1>Northland <span>A Church Distributed</span></h1></a>
			</div>
			
			<div id="header-small-right">
				{!-- user-login-box --}
				{if logged_in}
					<span>Logged in as <a href="/profile" target="_blank">{screen_name}</a> - <a onclick="logoutandreload()" >Log Out</a></span>
				{if:else}
					<span><a class="user-login" href="#login-register-box">Login</a></span>
				{/if}	
				<span> </span><span><a href="<?php if ($detect->isTablet()) { echo 'https://insite.northlandchurch.net/givingweb/mobilegiving.jsp'; } else { echo 'http://insite.northlandchurch.net/insitegiving/giving.do'; } ?>" target="_blank">Tithes &amp; Offerings</a></span>

				{if group_id == "1" || group_id == "22" || group_id == "13"}
					<span>
					
						<script type="text/javascript">
				
						function StartServiceLiveCheck() {
							UpdateServiceLiveCheck();
							setTimeout("StartServiceLiveCheck()", 20000);
						}
						
						function UpdateServiceLiveCheck() {
							$.ajax({
								url: "/_component/isservicelive",
								success: function(data) {
									if (data.indexOf("true") != -1) {
										$("#service_live").replaceWith("<a id='service_live' onclick='confirm_turn_service_off()'>Service is currently LIVE</a>");
									}
									else {
										$("#service_live").replaceWith("<a id='service_live' onclick='confirm_turn_service_on()'>Service is currently OFF</a>");
									}
								}
							});
						}
						
						function confirm_turn_service_on() {
							var r=confirm("Are you sure you want to turn service ON");
							if (r==true) { 
								$.ajax({ 
									url: "/_component/change_servicelive/on/"
								}).done(function() { UpdateServiceLiveCheck(); });
							}
						}
						
						function confirm_turn_service_off() {
							var r=confirm("Are you sure you want to turn service OFF");
							if (r==true) { 
								$.ajax({ 
									url: "/_component/change_servicelive/off/"
								}).done(function() { UpdateServiceLiveCheck(); });
							}
						}

						</script>
						<b><a style="cursor:pointer" href="/admin" target="_blank">Admin Console</a> | <a id="service_live"></a></i></b>
					</span>
				{/if}
			</div>
		</div>
	</div>
	<div class="nav-shadow"></div>
</div>

{!-- Group Size Popup Modal --}
<div style="display:none">
<a class="groupsize_modal" href="#modal_container" style="display:none"></a>
	<div id="modal_container">
			{if logged_in}
			<div id="modal-box">
			
				<h1>Welcome back {screen_name}!</h1>
				<div class="modal-contents">
					<p>How many people are worshiping with you today?</p> 
					<input type="textbox" id="num_worshipers" class="modal-field" maxlength="3" value="1">
					<div class="clear"></div>
					<div id="modal_invalidnumber" style="display:none">Please enter a valid number of worshipers to proceed.</div>
				</div>
				<div class="modal-submit" id="update_number_worshipers">Submit</div>
			</div>
			{if:else}
			<div id="modal-box" style="padding-bottom: 0px">
				<h1 id="test_name">Welcome to Northland's Online Worship!</h1>
				<h1 style="font-size: 14px; text-align:center">
					<a class='user-login' href='#login-register-box'>Sign-in or Register</a> in under 30 seconds.
				</h1>				
				
				<div class="modal-contents">
					<p>Enter your name:</p>
					<input type="textbox" id="name_worshipers" class="modal-field" style="width:205px;" maxlength="40" value="">
				</div>
				<div class="modal-contents">
					<p>How many people are worshiping with you today?</p> 
					<input type="textbox" id="num_worshipers" class="modal-field" maxlength="3" value="1">
					<div class="clear"></div>
					<div id="modal_invalidnumber" style="display:none">Please enter a valid number of worshipers to proceed.</div>
				</div>
				<div class="modal-submit" id="update_number_worshipers">Submit</div>
				
				<div style="height: 20px"></div>
				
				<div style="text-align: center; padding: 10px 0px; border: 1px solid #154666; margin-bottom: 20px; background-color: rgb(51, 119, 170); box-shadow: 0 0 10px #154666; border-radius: 6px; display:none" id="alert_enter_name">
					Please enter a name to join worship.
				</div>
				<div class="clear"></div>
			</div>
			{/if}
	</div>	
</div>

{if !logged_in}
{!-- Used for profanity filter since filter can't update textbox directly --}
<div id="anonymous_name" style="display: none"></div>
{/if}

<script type="text/javascript">
var logged_in_groupsize = 1; // Groupsize for current user, if hasn't clicked modal yet is stored as 0
var num_worshipers_submitted = 0; // Flag for whether number of worshipers has been submitted

function AutoSubmitNumberWorshipers() {
	if (num_worshipers_submitted == 0) {
		$('#update_number_worshipers').click();
		num_worshipers_submitted = 1;
	}
}

function InitializeEventHandlers() {
	setTimeout("AutoSubmitNumberWorshipers()", 90000);

	{if logged_in}
	$('#update_number_worshipers').click(function(e) {
		num_worshipers_submitted = 1;
		var temp_groupsize = $('#num_worshipers').val();
		$.fancybox.close();
		
		if ($.isNumeric(temp_groupsize) && temp_groupsize > 0 && temp_groupsize < 100) {
			logged_in_groupsize = temp_groupsize;
			UpdateGroupSize(logged_in_groupsize);
			UpdateMyUserInfo();
			setTimeout("UpdateStats(1, logged_in_groupsize)", 120000); // Add to stats after 120 seconds
		}
		else {
			setTimeout("UpdateStats(1, 1)", 120000); // Add to stats after 120 seconds
		}
	});
	{if:else}
	$('#update_number_worshipers').click(function(e) {
		num_worshipers_submitted = 1;
		var temp_groupsize = $('#num_worshipers').val();
		
		if ($.trim($("#name_worshipers").val()).length > 0) {
			$("#anonymous_name").text($.trim($("#name_worshipers").val()));
			$("#anonymous_name").profanityFilter({
				externalSwears: '/_js/swearWords.json'
			});
			
			chat_nickname = $.trim($("#anonymous_name").text());
			
			if ($.isNumeric(temp_groupsize) && temp_groupsize > 0 && temp_groupsize < 100) {
				logged_in_groupsize = temp_groupsize;
				UpdateGroupSize(logged_in_groupsize);
				UpdateMyUserInfo();
				setTimeout("UpdateStats(1, logged_in_groupsize)", 120000); // Add to stats after 120 seconds
			}
			else {
				setTimeout("UpdateStats(1, 1)", 120000); // Add to stats after 120 seconds
			}
			
			$.fancybox.close();
		}
		else {
			if ($("#alert_enter_name").is(":visible")) {
				$("#alert_enter_name").fadeOut(function() {
					$("#alert_enter_name").fadeIn();	
				});
			}
			else {
				$("#alert_enter_name").slideDown();
			}			
		}
	});
	{/if}
	
	$(".user-login").click(function() { num_worshipers_submitted = 1; });

	$(".groupsize_modal").fancybox({ 'modal': true,	'scrolling': 'no', 'width': 435, 'padding': 0, 'scrolling': 'no', 'overlayOpacity': 0.9, 'overlayColor': '#10202b' }).trigger('click');
	 
	{if logged_in}
		$('#num_worshipers').keydown(function(event) {
			if (event.keyCode == '13') { $('#update_number_worshipers').trigger('click'); }
		}).focus();	
	{if:else}
		$("#name_worshipers").keyup(function(event) {
			if ($.trim($("#name_worshipers").val()).length == 0) {
				$("#alert_enter_name").slideDown();
			}
			else {
				$("#alert_enter_name").slideUp();
			}
		});
		
		$("#name_worshipers").keydown(function(event) {
			if (event.keyCode == '13') { $('#num_worshipers').focus().select(); }
		}).focus();	
		
		$('#num_worshipers').keydown(function(event) {
			if (event.keyCode == '13') { $('#update_number_worshipers').trigger('click'); }
		});	
	{/if}	 
		
	$("#share_form").submit(function() { 
		$.post("/scripts/share-worship-email.php", { from_name: $('#shareform_from_name').val(), from_email: $('#shareform_from_email').val(), to_name: $('#shareform_to_name').val(), to_email: $('#shareform_to_email').val(), message: $('#shareform_message').val() }, function(data) { 
			if (data == 1) { alert("Thanks! Your email was successfully sent."); }
			else { alert("There was an error sending your email. Please contact an admin.<br>(Error: " + data + ")"); }
		});
				
		return false;
	});
	
	$(window).bind('beforeunload', function() { 
		UpdateStats(0, 0);
	});
	
	$(function(){
		$( ".tabs" ).tabs({ fx: { opacity: 'toggle' } });
		//$( ".tabs" ).tabs( "option", "selected", 2 );
		$( ".tabs" ).bind( "tabsselect", function(event, ui) {
			if (ui.panel.id == 'worship-tab') { LoadIssuu(); }
		});
	});
			
	LoadMap(); // Load Google Map when page ready
		
	$('#chat-right').click(function() { ModifyChatTabIndex(1); });
	$('#chat-left').click(function() { ModifyChatTabIndex(-1); });
	$('#filter-search').keyup(function() { 
		list_toggle = 'everyone';
		$('#filter-buttons').removeClass('current-friends').removeClass('current-groups').addClass('current-all');
		FindPeople($('#filter-search').val());
	});

}
</script>
{!-- End Group Size Modal --}

<script type="text/javascript" src="/_assets/jwplayer/5_9/jwplayer.js"></script>

<script type="text/javascript" src="/_assets/js/slimScroll.min.js"></script>

<script type="text/javascript">
	var myGroupSize = 1;	
	function UpdateGroupSize(num) {
		myGroupSize = num;
		if (socket && socket.connected) {
			socket.emit('update user', { groupsize: logged_in_groupsize, nickname: chat_nickname});
		}
	}
</script>

<!-- Code to update login/logout to stats -->
<script type="text/javascript">
function UpdateStats(action_login, groupsize) {
	{if logged_in}
		// Store that user logged in
		if (action_login == 1) {
			$.post("/scripts/update-stats.php", { member_id: {member_id}, anon: '0', action_login: '1', group_size: groupsize, lat: client_latitude, lng: client_longitude, location: client_location});
		}
		// Store that user logged out
		else if (action_login == 0) {
			$.post("/scripts/update-stats.php", { member_id: {member_id}, anon: '0', action_login: '0', group_size: '0', lat: client_latitude, lng: client_longitude, location: client_location});
		}
		else {
			$.post("/scripts/update-stats.php", { member_id: {member_id}, anon: '0', action_login: action_login, group_size: '0', lat: client_latitude, lng: client_longitude, location: client_location}, function() { location.reload(); });
		}
	{if:else}
		// Store that user logged in
		if (action_login == 1) {
			$.post("/scripts/update-stats.php", { member_id: '<?php echo $member_id_reference; ?>', anon: '1', action_login: '1', group_size: groupsize, lat: client_latitude, lng: client_longitude, location: client_location});
		}
		// Store that user logged out
		else if (action_login == 0) {
			$.post("/scripts/update-stats.php", { member_id: '<?php echo $member_id_reference; ?>', anon: '1', action_login: '0', group_size: '0', lat: client_latitude, lng: client_longitude, location: client_location});
		}
		else {
			$.post("/scripts/update-stats.php", { member_id: '<?php echo $member_id_reference; ?>', anon: '1', action_login: action_login, group_size: '0', lat: client_latitude, lng: client_longitude, location: client_location}, function() { location.reload(); });
		}
	{/if}
}
</script>
<!-- End code to update login/logout to stats -->

<script type="text/javascript">	
	function StartMapUpdateCycle() {
		UpdateViewport();
		setTimeout("StartMapUpdateCycle()", 30000);
	}
	
	var ChatUserUpdateStartedFlag = false;
	function StartChatUsersUpdateCycle() {
		if (!ChatUserUpdateStartedFlag) {
			ChatUsersUpdateCycle();
		}
	}
	
	function ChatUsersUpdateCycle() {
		UpdateChatList();
		UpdateChatCount();
		setTimeout("ChatUsersUpdateCycle()", 10000);
	}
</script>

{!-- EE Friends Module Code --}
<script type="text/javascript">
var friends_array = [];
var list_toggle = 'signedin';

function GetFriendships() {
	$.getJSON('/_component/friends-check/', function(data) {
		for (i = 0; i < data.length; i++) {	friends_array.push(data[i].toString());	}	
		UpdateFriendships();
	});	
}

function ChangeFriendship(uid) {
	$('#star' + uid).addClass('star-loading'); 	
		
	// User is already friends with this person, so remove them
	if ($.inArray(uid.toString(), friends_array) != -1) {
	    $.ajax({
		url: '/_component/friends-add/' + uid + '/delete/',
		success: function() { 
			friends_array.splice($.inArray(uid.toString(), friends_array),1);
			CheckFriendship(uid);
			UpdateChatList();
			}
		});
	} 
	
	// User is not friends with this person, so add them
	else { 		
		$.ajax({
		url: '/_component/friends-add/' + uid + '/',
		success: function() { 			
			friends_array.push(uid.toString());
			CheckFriendship(uid);
			UpdateChatList();
			}
		});
	}	
}


// Checks to see if the user is logged in user.
function CheckSignedIn(temp_uid, temp_str) {
	uid = temp_uid.toString();
	document.getElementById('keevalue').value = uid + " : " + temp_str + " : " + temp_str.indexOf("Worshiper");			

	if (temp_str.indexOf("Worshiper") == 0) {
		$('#worshiper' + uid).addClass('notsignedin').removeClass('signedin'); 
	} else {
		$('#worshiper' + uid).removeClass('notsignedin').addClass('signedin');
	}
}

// Checks to see if logged in user is friends with another UID and changes star next to user.
function CheckFriendship(temp_uid) {
	uid = temp_uid.toString();
	if (friends_array.indexOf(uid) != -1) {
		$('#star' + uid).removeClass('star-loading').addClass('star-selected'); 
		$('#worshiper' + uid).removeClass('notfriend').addClass('friend');
	}
	else {
		$('#star' + uid).removeClass('star-loading').removeClass('star-selected'); 
		if (list_toggle == 'friends') { $('#worshiper' + uid).addClass('notfriend').removeClass('friend'); }
		else { $('#worshiper' + uid).addClass('notfriend').removeClass('friend'); }
	}
}

function UpdateFriendships() {
	for (i = 0; i < friends_array.length; i++) {
		$('#star' + friends_array[i]).removeClass('star-loading').addClass('star-selected'); 
		$('#worshiper' + friends_array[i]).removeClass('notfriend').addClass('friend');
	};
}

function FilterChatList() {
	if (list_toggle == 'everyone') {
		$('#friends_hide').html("");
		$('#signedin_hide').html("");
		$('#filter-buttons').removeClass('current-friends').removeClass('current-groups').removeClass('current-signedin').addClass('current-all');
	}
	else if (list_toggle == 'signedin') {
		$('#friends_hide').html("");
		$('#signedin_hide').html("<style>.notsignedin { display: none; }</style>");
		$('#filter-buttons').removeClass('current-friends').removeClass('current-groups').removeClass('current-all').addClass('current-signedin');
	}
	else if (list_toggle == 'friends') {
		$('#signedin_hide').html("");
		$('#friends_hide').html("<style>.notfriend { display: none; }</style>");
		$('#filter-buttons').removeClass('current-all').removeClass('current-groups').removeClass('current-signedin').addClass('current-friends');
	}
	else if (list_toggle == 'findpeople') {
		$('#filter-buttons').removeClass('current-friends').removeClass('current-groups').removeClass('current-signedin').addClass('current-all');
		$('#friends_hide').html("<style>.person { display: none; } .person-found{ display: block; }</style>");
	}	
}

function UpdateChatList() {		
	var num_friends = $('.friend').not('.offline').length; // Number of friends
	var num_everyone = $('.person').not('.offline').length + 1; 
	var num_signedin = $('.person').not('.notsignedin').length; 
	$('#number-friends').replaceWith('<span id="number-friends">' + num_friends + '</span>');
	$('#number-all').replaceWith('<span id="number-all">' + num_everyone + '</span>');
	$('#number-signedin').replaceWith('<span id="number-signedin">' + num_signedin + '</span>');
}

function ShowFriends() { 
	list_toggle = 'friends';
	FilterChatList();
	UpdateChatList();
}

function ShowEveryone() {
	list_toggle = 'everyone';
	$("#filter-search").val("");
	FilterChatList();
	UpdateChatList();	
}

function ShowSignedIn() {
	list_toggle = 'signedin';
	$("#filter-search").val("");
	FilterChatList();
	UpdateChatList();	
}

function ShowGroups() {
	list_toggle = 'groups';
	$("#filter-search").val("");
	FilterChatList();
	UpdateChatList();
}


</script>
{!-- End EE Friends Module Code --}

{!-- Google Maps Javascript --}
<script type="text/javascript" src="/_assets/js/markerclusterer_packed.js"></script>
<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?sensor=false"></script>
<script type="text/javascript" src="/_assets/js/infobox_packed.js"></script>
<script type="text/javascript">
	var map;
	var markerCluster;
	var usersArray = {};
	var infobox_options = {
		disableAutoPan: false,
		pixelOffset: new google.maps.Size(-130, -175),
		closeBoxURL: ""
	};
	var infoWindow = new InfoBox(infobox_options);
		
	function LoadMap() {
		var mapOptions;
			mapOptions = {
			zoom: 7,
			scrollwheel: false,
			center: new google.maps.LatLng(28.684922, -81.336486),
			mapTypeId: google.maps.MapTypeId.HYBRID,
			streetViewControl: false,
			panControl: false,
			overviewMapControl: false,
			mapTypeControl: false
			};
		
		map = new google.maps.Map(document.getElementById("map-viewer"), mapOptions);
		markerCluster = new MarkerClusterer(map, [], { zoomOnClick: false, minimumClusterSize: 1, gridSize: 25 });
		
		//google.maps.event.addListener(map, 'bounds_changed', function() { UpdateViewport(); })
		google.maps.event.addListener(map, 'zoom_changed', function() { infoWindow.close(); });
		google.maps.event.addListener(markerCluster, 'click', function(markercluster) { ClusterClicked(markercluster) });

	}
	
	// User info container to store latitude, longitude, and UID. Has functions for returning Google Marker and LatLng objects
	function UserInfo(uid) {
		this.uid = uid;
		this.latlng = new google.maps.LatLng();
		this.location = "";
		this.fullname = "";
		this.role = null;
		this.avatarurl = "";
		this.marker = new google.maps.Marker();
		this.groupsize = 1;
				
		this.SetLatLng = function(lat, lng) { 
			this.latlng = new google.maps.LatLng(lat,lng); 
			this.marker = new google.maps.Marker({position: this.latlng, title: uid.toString()});
		}
		this.SetLocation = function (loc) { this.location = loc; }
		this.SetFullName = function(name) { if (name) { this.fullname = name; } }
		this.SetGroupSize = function(size) { this.groupsize = size; }
		this.SetSignedIn = function() { this.signedin = true; }
		this.GetUID = function() { return this.uid; }
		this.GetMarker = function() { return this.marker; }
		this.GetLatLng = function() { return this.latlng; }
		this.GetLocation = function() { return this.location; }
		this.GetFullName = function() {
			if (this.fullname) { return this.fullname; }
			else { return ""; }
		}
		this.GetGroupSize = function() { return this.groupsize; }
		//this.toString = function() { return "UID: " + this.uid + ", Name: " + this.fullname + ", LatLng: " + this.latlng + ", Location: " + this.location; }	
	}
	
	// Returns UserInfo object for uid from userarray, false on fail
	function GetUserInfo(uid, userarray) {
		return userarray[uid];
	/*	for (var i = 0; i < userarray.length; i++) {
			if (userarray[i].uid == uid) { return userarray[i]; }
		}		*/
	}
	
	// Event handler, run when user pans/zooms Google Map
	function UpdateViewport(){
		var i = 0;		
		var viewportusers_array = [];
		var html_content = "";
		
		for (key in markersArray) {
			viewportusers_array.push(markersArray[key]);
		}
		markerCluster.clearMarkers(); // Update MarkerClusterer
		markerCluster.addMarkers(viewportusers_array);
		//console.log("Google Map updated");
	}	
		
	var first_map_update = 1;
	var worshipersjsonfile;
		
	// Adds MarkerInfo object to usersArray and adds marker to map with event handlers
	/*function AddMarker(lat, lng, loc, uid, fullname, groupsize) {	
		if (lat != 0 && lng != 0) {	
			var userInfo = new UserInfo(uid);			
			userInfo.SetLatLng(lat, lng);
			userInfo.location = loc;
			userInfo.fullname = fullname;
			userInfo.groupsize = groupsize;
			
			if (uid != 0) {
				usersArray.push(userInfo);	
			}		
			markersArray.push(userInfo.marker);
		}
	}*/
	
	function AddMarker(chatid, lat, lng) {
		if (lat && lng && lat != 0 && lng != 0) {	
			markersArray[chatid] = new google.maps.Marker({position: new google.maps.LatLng(lat,lng), title: chatid.toString()});
		}
	}
	
	// Removes marker from map when user leaves
	/*function RemoveMarker(uid) {
		var i = 0;
		temp_array = usersArray; // Temp array for manipulation before updating actual array	
		while (i < usersArray.length) {
			if (uid == usersArray[i].uid) {	
				temp_array.splice(i,1);			
				//console.log("UID: " + uid + " removed from map");
				break;
			}			
			i++;
		}
		usersArray = temp_array; // Update main array with manipulated array
	}*/
	function RemoveMarker(chatid) {
		delete markersArray[chatid];
		/*for (var i = 0; i < markersArray.length; i++) {
			if (uid == markersArray[i].title) {	
				markersArray.splice(i,1);
				break;
			}			
			i++;
		}*/
	}

	function InfoWindowClose() {
		infoWindow.close();
	}
	
	// Event handler for cluster click	
	function ClusterClicked(markercluster) {
		var cluster_markers = [];
		infoWindow.close();
		
		cluster_markers = markercluster.getMarkers(); // Get markers managed by cluster
		map.panTo(markercluster.getCenter());
		
		/*if (markercluster.getSize() == 1) {
			var uid = cluster_markers[0].getTitle();
						
			var user_info = GetUserInfo(cluster_markers[0].getTitle(),usersArray);
			
			var userinfo = GetUserInfo(uid,usersArray);
			var html_content;
			html_content = "";
			
			html_content = "<div id='infowindow'>";
			html_content +=	"<div class='infowindow_name'>";
			if (userinfo && userinfo.role) {
				var dom_id = user_info.uid + "_" + user_info.fullname.split(' ').join('_');
				html_content += "<img class='infowindow_profile_avatar' src='/images/member_photos/50x50/photo_" + uid + ".jpg' onerror=\"this.src='/images/avatar.png'\" /><div class='infowindow_text'>" + userinfo.fullname;
				{if logged_in}
				if ($('#personchat' + dom_id.substr(0, dom_id.indexOf("_"))).length) {
					html_content += " - <a onclick=\"userClicked(this, 'testroom@conference.insitedev2.northlandcc.net/" + dom_id + "', '" + dom_id + "')\">Chat</a>";
				}
				{/if}
				html_content += "</div></div><div class='clear'></div>";
				html_content +=	"<div class='infowindow_profile_show'><div id='infowindow_profile_single'></div>";
				html_content +=	"<div class='infowindow_prayer_header'>Prayer Requests</div>";
				html_content +=	"<div id='infowindow_prayer_body_single'></div>";
			}
			else {
				html_content += "<div class='infowindow_multiple_name'>Anonymous Worshipers at 1 Site</div>";
			}
			html_content += "</div>";
			html_content += "<div class='infowindow_close'><a onclick='InfoWindowClose()'>Close</a></div>";
			
			infoWindow.setContent(html_content);						
			
			if (userinfo && userinfo.role) {
				$.ajax({
			  		url: '/_component/get-latestprayer/' + uid,
			  		success: function(data) {
						$("#infowindow_prayer_body_single").empty();
						if (data != '') {
							$("#infowindow_prayer_body_single").append(data);
						}
						else {
							$("#infowindow_prayer_body_single").append('No recent prayer requests');
						}
		  			}
				});		
				$.ajax({
			  		url: '/_component/get-profilebio/' + uid,
			  		success: function(data) {
						$("#infowindow_profile_single").empty();
						if (data != '') {										
							$("#infowindow_profile_single").append(data);
						}
						else {
							$("#infowindow_profile_single").append('No user profile posted');
						}
		  			}
				});
			}
			
		}
		else if (markercluster.getSize() > 1) {	*/
			var num_anonusers = 0; // Number of anonymous users
			var num_anonsites = 0;
			var dom_id;
			
			html_content = 	"<div id='infowindow'>";
			for (var i = 0; i < cluster_markers.length; i++) {	
				var userinfo = usersArray[cluster_markers[i].getTitle()];				
				
				if (userinfo) {		
					if (userinfo.role) {
						html_content += "<div class='infowindow_name'><img class='infowindow_profile_avatar' src='/images/member_photos/50x50/photo_" + userinfo.uid + ".jpg' onerror=\"this.src='/images/avatar.png'\" /><div class='infowindow_text'><a onclick=\"ShowInfoWindowProfile(" + userinfo.uid + ")\">" + userinfo.fullname + "</a>";
					}
					else {
						html_content += "<div class='infowindow_name'><img class='infowindow_profile_avatar' src='/images/avatar.png' /><div class='infowindow_text'>" + userinfo.fullname;
					}
					
					if (userinfo.uid != <?php echo $member_id_reference; ?> && userinfo.uid != 'anon_<?php echo $member_id_reference; ?>') {
						dom_id = userinfo.uid + "_" + userinfo.fullname.split(' ').join('_');
						
						html_content += " - <a onclick=\"StartPrivateChat('" + userinfo.uid + "', '" + userinfo.fullname + "')\">Chat</a>";
					}
					else {
						html_content += "You";
					}
					
					if (userinfo.groupsize > 1) {
						html_content += " (" + userinfo.groupsize + " viewers)";
					}
					
					html_content += "</div></div><div class='clear'></div><div class='infowindow_multiple_profile' id='infowindow_multiple_profile" + userinfo.uid +"'></div><div class='clear'></div>";
				}
			}
			
			html_content += "</div><div class='infowindow_close'><a onclick='InfoWindowClose()'>Close</a></div>";
			infoWindow.setContent(html_content);
		//}
		
		infoWindow.setPosition(markercluster.getCenter());
		infoWindow.open(map);
	}
	
function ShowInfoWindowProfile(uid) {
	var html_content =	"<div class='infowindow_profile_show'><div id='infowindow_profile" + uid + "'></div>";
	html_content +=	"<div class='infowindow_prayer_header'>Prayer Requests</div>";
	html_content +=	"<div id='infowindow_prayer_body" + uid + "'></div>";
	html_content +=	"<div class='infowindow_chat'></div>";
	html_content +=	"</div></div>";
	
	$("#infowindow_multiple_profile" + uid).empty().append(html_content);
	$.ajax({
		url: '/_component/get-latestprayer/' + uid,
		success: function(data) {
			if (data != '') { $("#infowindow_prayer_body" + uid).empty().append(data); }
			else { $("#infowindow_prayer_body" + uid).empty().append('No recent prayer requests'); }
			}
	});		
	$.ajax({
		url: '/_component/get-profilebio/' + uid,
		success: function(data) {
			if (data != '') { $("#infowindow_profile" + uid).empty().append(data); }
			else { $("#infowindow_profile" + uid).empty().append('No user profile posted');	}
			}
	});
	
	if ($("#infowindow_multiple_profile" + uid).hasClass("infowindow_visible")) {
		$('.infowindow_multiple_profile').hide().removeClass("infowindow_visible");
	}
	else {
		$('.infowindow_multiple_profile').hide().removeClass("infowindow_visible");
		$("#infowindow_multiple_profile" + uid).addClass("infowindow_visible").show();
	}	
}	
	
</script>
{!-- End Google Maps Javascript --}

<script type="text/javascript">
{if service_live != "true"}
var service_live_prompted = 0; // Have we already asked the user if they want to join live service?

function StartCheckServiceLive() {
	if (service_live_prompted == 0) {
		UpdateCheckServiceLive();
		setTimeout("StartCheckServiceLive()", 30000);
	}
}

function UpdateCheckServiceLive() {
	$.ajax({
		url: "/_component/isservicelive",
		success: function(data) {
			if (data.indexOf("true") != -1) {
				if (service_live_prompted == 0) {
					var r = confirm("You are currently watching last week's service. This weeks' service is now live. Would you like to join live online worship?");
					if (r == true) { location.reload(); }
					service_live_prompted = 1;
				}
			}
		}
	});
}
{/if}

function FindPeople(name) {
	if (name.length > 0) {
		$('.person').removeClass('person-found');
		
		$(".person > .person-info > .fullname").each(function() {
			if ($(this).text().toLowerCase().indexOf(name.toLowerCase()) != -1) {
				$(this).parents().eq(1).addClass("person-found");
			}
		});
		
		list_toggle = 'findpeople';
		FilterChatList();
	}
	else {
		list_toggle = 'everyone';
		FilterChatList();
	}
}

function clickProfileExpand(el, profilename, userid) {	
	if (!$("."+profilename).is(':visible')) {
		$("#prayer-text" + userid).empty();
		$("#prayer-text" + userid).append("Loading prayers");
		$("#profile-text" + userid).empty();
		$("#profile-text" + userid).append("Loading profile");
		$.ajax({
  		url: '/_component/get-latestprayer/' + userid,
  		success: function(data) {
			$("#prayer-text" + userid).empty();
			if (data != '') {
				$("#prayer-text" + userid).append(data);
			}
			else {
				$("#prayer-text" + userid).append('No recent prayer requests');
			}
  			}
		});		
		$.ajax({
  		url: '/_component/get-profilebio/' + userid,
  		success: function(data) {
			$("#profile-text" + userid).empty();
			if (data != '') {
				$("#profile-text" + userid).append(data);
			}
			else {
				$("#profile-text" + userid).append('No user profile posted');
			}
  			}
		});		
		 $(".mini-profile").hide(); 
	}	
	$("."+profilename).toggle("fast");
}

/************************************************************************
 *                       ******  LOGOUT  *******
 ***********************************************************************/
function logoutandreload() {
	$.post("/scripts/update_worship_heartbeat.php", { member_id: "<?php echo $member_id_reference; ?>", disconnect: "1" });
	//$.cookies.del('ee_screenname');
	$.ajax({
	  	url: "/index.php?ACT=10",
	  	complete: function() { location.reload(); }
	});
}
</script>

{if logged_in}
{!-- Notes Tab Javascript --}
<script type="text/javascript">	
	function successResponse(responsejson) {
		// Update notes form to use the entry_id of the entry created if it's a new entry
		if ($('input[name=entry_id]').val() == 0) { $('input[name=entry_id]').val(responsejson.entry_id); }
	}	
</script>
{!-- End Notes Tab Javascript --}
{/if}


{!-- Node Chat --}
<script src="/_assets/onlineworship/socket.io.js"></script>
<script src="/_assets/onlineworship/handlebars-1.2.0.js"></script>
<script src="/_assets/onlineworship/moment.min.js"></script>

<script type="text/x-handlebars-template" id="rosteruser_html"> 	
	<div id="worshiper{{chatid}}" class="person {{#ifCond usertype "minister"}}online-minister {{/ifCond}}notfriend {{#handlebars_if usertype}}signedin{{else}}notsignedin{{/handlebars_if}}">
		<div class="avatar-bg">
			{{#handlebars_if usertype}}
				<img src="/images/member_photos/50x50/photo_{{chatid}}.jpg" onerror="this.src='/images/avatar.png'">
			{{else}}
				<img src="/images/avatar.png">
			{{/handlebars_if}}
		</div>
		<div class="person-info">
			<div class="fullname" id="fullname_{{chatid}}">{{name}}</div>
			{{#ifCond usertype "minister"}}<div class="fullname_title">- Minister</div>{{/ifCond}}
			{{#ifCond usertype "support"}}<div class="fullname_title">- Tech Support</div>{{/ifCond}}
			<div class="clear"></div>
			<p>
				<span id="address{{chatid}}" class="notupdatedaddress rosteraddress">{{#handlebars_if loc}}{{loc}}{{else}}&nbsp;{{/handlebars_if}}</span>
			</p>
			<div class="clear"></div>
		</div>
		<div class="people-options">
			<ul id="person-nav">
				<li id="person-chat">
					<a id="personchat{{chatid}}" class="chat-roster-person" href="javascript:StartPrivateChat('{{chatid}}', '{{name}}')">Chat</a>
				</li>
				{{#handlebars_if email}}
				<li id="person-email">
					<a href="mailto:{{this.email}}" target="_blank">Email</a>
				</li>
				{{/handlebars_if}}
				{{#handlebars_if usertype}}
				<li id="person-profile">
					<a style="left:80px" onclick="clickProfileExpand(this, 'profile{{chatid}}', {{chatid}} )">Profile</a>
				</li>
				{{/handlebars_if}}
			</ul>
		</div>
		{{#handlebars_if usertype}}
		{if logged_in}		
		<div class='star-container'>
			<ul class='friend-star'>		
				<li class='star' id='star{{chatid}}'><a onclick='ChangeFriendship("{{chatid}}")'>Friend Star</a></li>
			</ul>
		</div>
		{/if}
		{{/handlebars_if}}
		<div class="clear"></div>
		
		{{#handlebars_if usertype}}
		<div class="mini-profile profile{{chatid}}" style="display: none">
			<h1>About {{name}}</h1>
			<ul>
				<li id="profile-text{{chatid}}"></li>
			</ul>
			<h1>Prayer Requests</h1>
			<ul>
				<li id="prayer-text{{chatid}}"></li>
			</ul>
		<div class="mini-profile-shadow"></div>
		{{/handlebars_if}}
	</div></div>
</script>

<script type="text/x-handlebars-template" id="groupmessage_html">
	<li id="groupmessage_{{id}}">
		<div>
			<img src="/images/member_photos/50x50/photo_{{chatid}}.jpg" width="26" height="26" onerror="this.src='/images/avatar.png'">
		</div>
		<div class="group-chat-text">
			<h1>
				<div>{{nickname}}</div>
				<span class="chat-time-stamp">{{dateFormat}}</span>
			</h1>
			<div class="groupchat_link" style="float: right">
					<a class="private_link_{{chatid}}" onclick="StartPrivateChat('{{chatid}}', '{{nickname}}')" {{#handlebars_if user_online}}{{else}}style="display:none"{{/handlebars_if}}>Private Chat</a>
				{if group_id == "1" || group_id == "19" || group_id == "13"}
					 - <a onclick="RemoveGroupMessage('{{id}}')">Remove</a>
				{/if}
			</div>
			<div class="clear"></div>
			<p>{{{message}}}</p>
		</div>
		<div class="clear"></div>
	</li>
</script>


<script type="text/x-handlebars-template" id="privatecontainer_html">	
	<li id="privatecontainer_{{chatid}}" class="single-chat selected">
		<div class="chat-tab tab-selected" id="tab{{chatid}}">{{tabnickname}}</div>
		<div class="single-chat-window" id="div{{chatid}}" style="display: block; left: 0px;">
			<div class="single-chat-header" id="chat-header{{chatid}}">
				<h1>{{nickname}}</h1>
				<a class="chat-close" href="javascript:ClosePrivateChat('{{chatid}}')"></a>
			</div>
			<div id="pchatbox">
				<div {!--class="slimScrollDiv"--} style="position: relative; overflow: hidden; width: auto; height: 250px;">
					<div id="privatemessages_{{chatid}}" class="chatbox" style="overflow: hidden; word-wrap: break-word; width: auto; height: 250px;"></div>
				</div>
			</div>
				{!--<textarea id="pmsgbox{{chatid}}" class="pchatmsgbox" style="overflow: hidden; word-wrap: break-word; max-height: 25px; min-height: 25px; height: 25px;"></textarea>--}

			<form class="panel-footer private_form" id="private_form_{{chatid}}">
				<textarea id="private_chatfield_{{chatid}}" class="pchatmsgbox" style="overflow: hidden; word-wrap: break-word;"></textarea>
			</form>
		</div>
	</li>
</script>

<script type="text/x-handlebars-template" id="privatemessage_html">	
	{{#handlebars_if mine}}
		<div class="pmsg pmsg_me_bg">
			<p class="pmsg_body">{{{message}}}</p>
			<div class='pmsg_avatar right_avatar'>
				<img class='pmsg_right_avatar' height='26' width='26' src='/images/member_photos/50x50/photo_{member_id}.jpg' onerror="this.src='/images/avatar.png'">
				<div class="clear"></div>
				{{dateFormat}}
			</div>
		</div>	
	{{else}}		
		<div class="pmsg pmsg_you_bg">
			<div class="pmsg_avatar left_avatar">
				<img class="pmsg_left_avatar" height="26" width="26" src="/images/member_photos/50x50/photo_{{chatid}}.jpg" onerror="this.src='/images/avatar.png'">
				<div class="clear"></div>
				{{dateFormat}}
			</div>
			<p class="pmsg_body">{{{message}}}</p>
		</div>
	{{/handlebars_if}}
</script>

<script type="text/javascript">
	var firstconnection_flag = true;
	var groupmessage_template;
	var $groupchats, $privatechats, $users_count;
	{if logged_in}
	var chat_nickname = "{screen_name}";
	{if:else}
	var chat_nickname = "Worshiper <?php echo $member_id_reference; ?>";
	{/if}
	var chat_tabs_open = 0; 	// Number of chat tabs currently open
	var chat_slider_index = 0;	// Current index/location of slider
	var chat_tabs_max = 8; 		// Max number of chat tabs viewable at once
	var chat_tab_bar_width = 0; // Width of tab bar
	var current_chat_uid = "";	// Current opened chat UID
	
	Handlebars.registerHelper('handlebars_if', function(conditional, options) {
		if (typeof conditional === 'function' && toString.call(conditional) === '[object Function]') { conditional = conditional.call(this); }
		
		if ((!options.hash.includeZero && !conditional)) { return options.inverse(this); }
		else { return options.fn(this); }
	});
	
	Handlebars.registerHelper('ifCond', function(v1, v2, options) {
		if(v1 === v2) { return options.fn(this); }
		else { return options.inverse(this); }
	});
	
	function UpdateChatCount() {
		//var i = 0;
		var worshipers = 0;
		var sites = 0;
		/*while (i < usersArray.length) {
			if (!isNaN(usersArray[i].groupsize)) { worshipers += parseInt(usersArray[i].groupsize);}	
			else { worshipers++; }		
			i++;
		}*/
		
		for (var key in usersArray) {
			if (!isNaN(usersArray[key].groupsize)) { worshipers += parseInt(usersArray[key].groupsize);}	
			else { worshipers++; }	
			
			sites++;	
		}

		$users_count.html({if service_live == "true"}"LIVE - " + {/if}worshipers + " worshipers at " + sites + " sites");
		/*if ($(".rosteruser").length) { $users_count.html($(".rosteruser").length + 1 + " Users"); }
		else { $users_count.html("1 Worshiper at 1 Site"); }*/
	}
	
	function SendPrivateMessage(id, message) {
		if (id && message) {
			socket.emit('send private message', { receiverid: id, msg: message });
		}
	}
	
	{if group_id == "1" || group_id == "19" || group_id == "13"}
	function RemoveGroupMessage(messageid) {
		var confirmation = confirm("Are you sure you want to delete this group chat message?");
		if (confirmation == true) {
			socket.emit('remove group message s3cretc0de', messageid);
		}
	}
	
	function ClearGroupChat() {
		var confirmation = confirm("Are you sure you want to clear group chat?");
		if (confirmation == true) {
			socket.emit('clear group chat s3cretc0de');
		}
	}
	{/if}
	
	{if logged_in}
	function ChatLogin() {
		socket.emit('connect user', { nickname: chat_nickname, chatid: '<?php echo $member_id_reference; ?>', usertype: '{exp:member:custom_profile_data}{if online_worship_role}{online_worship_role}{if:else}Worshiper{/if}{/exp:member:custom_profile_data}', email: '{if email}{email}{/if}', latitude: client_latitude, longitude: client_longitude, location: client_location, groupsize: logged_in_groupsize });
	{if:else}
	function ChatLogin() {
		socket.emit('connect user', { nickname: chat_nickname , chatid: 'anon_<?php echo $member_id_reference; ?>', latitude: client_latitude, longitude: client_longitude, location: client_location, groupsize: logged_in_groupsize });
	{/if}
		$("#chat-disconnected").hide();
    	$('.pchatmsgbox').removeAttr("disabled").css("background-color","#FFF");
		$('#chatroster').removeClass('chatrosterdisconnected');
		$('.youdisconnected').remove();
	}
    
    Handlebars.registerHelper('dateFormat', function(context, options) {
		return moment(this.date).format("h:mma");
	});
	
	var first_connection = true;		// Flag for first connection to get group messages
	var duplicate_connection = false;	// Disconnected because of new user joining
			
	$(document).ready(function() {
		$("#nickname").focus();
		
		$(document).on('click', '.single-chat-header', function() {
			ToggleChatWindow($(this).attr('id').replace("chat-header",""));
		});
		
		$(document).on('click', '.chat-tab', function() { 
			ToggleChatWindow($(this).attr('id').substring(3));			
		});	
		
		$('#chatroster').slimScroll({ height: '750px', size: '9px', start: 'bottom', railVisible: true, railOpacity: 0.5, start: 'top' });

		$('#chat-box-list').slimScroll({ height: '313px', size: '9px', start: 'bottom', railVisible: true, alwaysVisible: 'true', railOpacity: 0.5, start: 'top' });

		$groupchats = $("#chat-box-list");
		$privatechats = $("#chat-slider-ul");
		$users_count = $("#current-viewers");
		
		$ministerroster = $("#minister");
		$techsupportroster = $("#tech-support");
		$peopleroster = $("#people");

		groupmessage_template = Handlebars.compile($("#groupmessage_html").html());
		rosteruser_template = Handlebars.compile($("#rosteruser_html").html());
		privatecontainer_template = Handlebars.compile($("#privatecontainer_html").html());
		privatemessage_template = Handlebars.compile($("#privatemessage_html").html());		
		
		ChatConnect();
        
        /*$("#nickname_container").submit(function(e){
			e.preventDefault();
			chat_nickname = $("#nickname").val();
			ChatLogin();
			$('#nickname_container').hide();
			$('#chatroom_container').show();
			$("#signedin_text").html("Signed in as " + chat_nickname);
			$("#nickname").val("");
		});*/
		
		$("#group_chat_form").submit(function(e) {
			e.preventDefault();
			
			var message = $("#groupchat_field").val();
			if (message.length) {
				socket.emit('send group message', message);
				
				$("#groupchat_field").val("");
			}
		});
	});		
	
	function ChatConnect() {
		socket = io.connect('http://node-chat.northlandchurch.net', {
            'reconnect': true,
            'reconnectionDelay': 2000,
            'max reconnection attempts': 10000,
            'forceNew': true
        });
        
        socket.on('connect', function() {
	     	ChatLogin();
	     	if (first_connection) {
		     	socket.emit("get recent messages");
		     	first_connection = false;
	     	}	     	
        });
                        
        socket.on('duplicate connection', function() {
	        duplicate_connection = true;
        });
        
        socket.on('disconnect', function() {
			$("#disconnected_label").fadeIn();			
			$('#chatroster').addClass('chatrosterdisconnected');
			$('.youdisconnected').remove();			
			$('.pchatmsgbox').attr("disabled","disabled").css("background-color","#BBB");
			$('.chatbox').append('<div class="pmsg_notification youdisconnected">You have been disconnected.</div> <div id="clear"></div>');
			
			if (duplicate_connection) {				
				$("#chat-disconnected").html('Disconnected from chat...<br>Another browser connected with your account').show();
			}
			else {
				$("#chat-disconnected").html('Disconnected from chat...<br>Attempting to reconnect').show();
				
			}				
        });       
        
        socket.on('chat users', function(data) {
	       /*$chatroster.html("");
	       $("#minister").html("");
	       $("#tech-support").html("");*/
	       
	       ClearChatUsers();
	       
	       if (data) {
		       for (i = 0; i < data.length; i++) {
			      AddChatUser(data[i]);
		       }
		   }
		   		   
		   StartChatUsersUpdateCycle();
        });
        
        socket.on('new chat user', function(data) {
			AddChatUser(data);
			
			$(".private_link_" + data.chatid).show();
        });
        
        socket.on('remove chat user', function(data) {
        	RemoveChatUser(data);
        });
        
        socket.on('group message', function(data) {
        	data.user_online = true;
	       $groupchats.prepend(groupmessage_template(data));	       
	    });
        
        socket.on('remove group message', function(data) {
	       $("#groupmessage_" + data).remove(); 
        });
        
        socket.on('clear group chat', function() {
	       $("#chat-box-list").html(""); 
        });
        
        socket.on('recent messages', function(data) {        
	       for(i = 0; i < data.length; i++) {
		       $groupchats.append(groupmessage_template(data[i]));
	       } 
        });
        
        socket.on('private message', function(data) {
			if(data.chatid && data.nickname) {
			    if ($("#privatecontainer_" + data.chatid).length == 0) {
					StartPrivateChat(data.chatid, data.nickname);
			    }
			    else {
					if (!$("#div" + data.chatid).is(":visible")) {
						$("#tab" + data.chatid).addClass('new-message');
					}		     
			    }
			      
			    if (data.mine && $("#privatemessages_" + data.chatid + " > div:last").hasClass("pmsg_me_bg")) {
				    $("#privatemessages_" + data.chatid + " > .pmsg:last").append("<p class='pmsg_body'>" + data.message + "</p>");
			    }
			    else if (data.mine == null && $("#privatemessages_" + data.chatid + " > div:last").hasClass("pmsg_you_bg")) {
				    $("#privatemessages_" + data.chatid + " > .pmsg:last").append("<p class='pmsg_body'>" + data.message + "</p>");
			    }
			    else {
				   $("#privatemessages_" + data.chatid).append(privatemessage_template(data));			   
			    }
			    
			    var elem = document.getElementById("privatemessages_" + data.chatid);
				elem.scrollTop = elem.scrollHeight;
			 }
        });
        
        socket.on('updated user', function(data) {   
        	if (data.chatid) {        		
        		if (data.latitude && data.longitude) {
	        		usersArray[data.chatid].SetLatLng(data.latitude, data.longitude);
	        		//RemoveMarker(data.chatid);
	        		AddMarker(data.chatid, data.latitude, data.longitude);
        		}
        		
        		if (data.location) {
	        		usersArray[data.chatid].location = data.location;
	        		$("#address" + data.chatid).text(data.location);
        		}
        		
        		if (data.groupsize) {
	        		usersArray[data.chatid].groupsize = data.groupsize;
        		}
        		
        		if (data.nickname) {
	        		usersArray[data.chatid].fullname = data.nickname;
	        		$("#fullname_" + data.chatid).text(data.nickname);
					$("#personchat" + data.chatid).attr("href", "javascript:StartPrivateChat('" + data.chatid + "', '" + data.nickname + "');");
        		}
        	}
        });
	}
	
	
	function AddChatUser(data) {
		if (data.usertype == "minister") { $ministerroster.prepend(rosteruser_template(data)); }
    	else if (data.usertype == "support") { $techsupportroster.prepend(rosteruser_template(data)); }
    	else { $peopleroster.prepend(rosteruser_template(data)); }
       
		if (document.getElementById("privatemessages_" + data.chatid)) {
       	   $("#privatemessages_" + data.chatid + " .user_disconnected").remove();       	   
       	   $("#private_chatfield" + data.chatid).removeAttr("disabled").css("background-color","#FFF");
       	}       	
		
       	AddUser(data.chatid, data.lat, data.lon, data.loc, data.name, data.groupsize, data.usertype);
       	AddMarker(data.chatid, data.lat, data.lon);
	}
	
	
	function RemoveChatUser(chatid) {
		$("#worshiper" + chatid).remove();	       
	       
       if (document.getElementById("privatemessages_" + chatid)) {
	        $("#privatemessages_" + chatid).append('<div class="pmsg_notification user_disconnected">This person has logged off.</div><div class="clear"></div>');
	        
	        $("#private_chatfield" + chatid).attr("disabled","disabled").css("background-color","#BBB");
       }      	       
       
       $(".private_link_" + chatid).hide();
       
       RemoveUser(chatid);
       RemoveMarker(chatid);
	}
	
	function ClearChatUsers() {
		markersArray = {};
		usersArray = {};
		
		UpdateMyUserInfo();	// Add my location/chat info back to the list
		
		$ministerroster.html("");
		$techsupportroster.html("");
		$peopleroster.html("");
	}
	
	
	function AddUser(chatid, lat, lng, loc, fullname, groupsize, role) {
		var userInfo = new UserInfo(chatid);			
		userInfo.SetLatLng(lat, lng);
		userInfo.location = loc;
		userInfo.fullname = fullname;
		userInfo.groupsize = groupsize;
		userInfo.role = role;
		
		usersArray[chatid] = userInfo;
		
		/*if (chatid != 0) {
			usersArray.push(userInfo);	
		}	*/
		
		//console.log(usersArray.toString());
	}
	
	
	function RemoveUser(chatid) {	
		delete usersArray[chatid];
	  /* for (var i = 0; i < usersArray.length; i++) {
			if (chatid == usersArray[i].uid) {	
				usersArray.splice(i,1);
				break;
			}
		}*/
	}
		
	function StartPrivateChat(chatid, nickname) {
		if ($("#privatecontainer_" + chatid).length == 0) {
			HideChatWindows();
			var tab_nickname = "";
			
			if (nickname.indexOf("Worshiper ") != -1) {
				tab_nickname = nickname.replace("Worshiper ", "");
			}			
			else if (nickname.length > 10) { tab_nickname = nickname.substr(0,10) + "...";	}
			else { tab_nickname = nickname; }
			
			$privatechats.append(privatecontainer_template({chatid : chatid, tabnickname: tab_nickname, nickname: nickname}));
			$("#private_chatfield_" + chatid).autosize();
						  
			 $("#private_chatfield_" + chatid).keypress(function(e) {
				 if (e.keyCode == 13) {
					 e.preventDefault();
					 SendPrivateMessage(chatid, $("#private_chatfield_" + chatid).val());
					 $("#private_chatfield_" + chatid).val("");
					 $("#private_chatfield_" + chatid).resize();
				 }				 
			 });			 
			 
			 $("#privatemessages_" +  chatid).slimScroll({ height: '250px', size: '8px', start: 'bottom', railVisible: true, railOpacity: 0.5 });
			 			
			// Reposition tabs if it's outside the max in the tab slider
			var chatid_tab_index = $('#privatecontainer_' + chatid).index('.single-chat');
			
			if (chatid_tab_index > chat_tabs_max + chat_slider_index - 1) {
				SetChatTabIndex(chatid_tab_index - chat_tabs_max + 1);
			}
			
			
			 
		}
		else {
			ToggleChatWindow(chatid);
		}
		
		$("#private_chatfield_" + chatid).focus();
		
		UpdateChatTabs();
	}		
	
	function ToggleChatWindow(chatid) {
		var $div = $("#div" + chatid);
		var $tab = $("#tab" + chatid);
		
		if ($div.is(":visible")) {
			$div.hide();
			$tab.removeClass('tab-selected');
		}
		else {
			$(".single-chat.selected > .single-chat-window").hide();
			$(".single-chat.selected > .chat-tab").removeClass("tab-selected");
			$(".single-chat.selected").removeClass("selected");
		
			$div.show();
			$("#privatecontainer_" + chatid).addClass('selected');
			$("#private_chatfield_" + chatid).focus();
			$tab.removeClass('new-message').addClass('tab-selected');
			
			// Reposition tabs if it's outside the max in the tab slider
			var chatid_tab_index = $('#privatecontainer_' + chatid).index('.single-chat');
			
			if (chatid_tab_index > chat_tabs_max + chat_slider_index - 1) {
				SetChatTabIndex(chatid_tab_index - chat_tabs_max + 1);
			}
			else if (chatid_tab_index < chat_slider_index) {
				SetChatTabIndex(chatid_tab_index);
			}
			
			/*var uid_tab_index; // Index # of chat tab in list	
	
			// Are there more tabs than allowed to be displayed at once?
			if (chat_tabs_open > chat_tabs_max) {
				uid_tab_index = $('#privatecontainer_' + uid).index('.single-chat');
				
				if (uid_tab_index != -1) {			
					// Tab is off the screen to the left
					if (uid_tab_index < chat_slider_index) {					
						SetChatTabIndex(uid_tab_index);
					}
					// Tab is off the screen to the right
					else if (uid_tab_index > chat_slider_index + chat_tabs_max - 1) {
						var set_chat_tab_index = chat_slider_index + chat_tabs_max - 1;
						console.log("Set Chat tab index: " + set_chat_tab_index);
						if(chat_tabs_open - set_chat_tab_index < chat_tabs_max) { 
						SetChatTabIndex(chat_tabs_open - chat_tabs_max); } // Don't let gaps appear after chat tabs if near the end of tabs						
						else { SetChatTabIndex(set_chat_tab_index); }
					}
				}
			}*/
			
			$("#privatemessages_" + chatid).scrollTop($("#privatemessages_" + chatid)[0].scrollHeight); 
		}
	}
	
	function UpdateChatTabs() {
		chat_tabs_open = $('.single-chat').length;			
		if (chat_tabs_open > chat_tabs_max) {
			chat_tab_bar_width = chat_tabs_max * 102; // 102 pixels wide per chat tab			
			
			if(chat_slider_index >= 0 && (chat_tabs_max + chat_slider_index) < chat_tabs_open) { $('#chat-right').show(); }
			else { $('#chat-right').hide(); }
					
			if(chat_slider_index <= 0) { $('#chat-left').hide(); }	
			else { $('#chat-left').show();	}
		}	
		else {
			chat_tab_bar_width = chat_tabs_open * 102; // 102 pixels wide per chat tab
			$('#chat-left').hide();
			$('#chat-right').hide();
		}
		
		// Hide some chat tabs
		$('.single-chat').each(function(index) {
			if (index < chat_slider_index || index > chat_slider_index + chat_tabs_max - 1) { $('#' + this.id).hide(); }		
			else { $('#' + this.id).show();	}		
		});	
		
		// Repositions chat windows to be above chat tab
		$('.single-chat-window').each(function() {
			var temp_divid = this.id.substring(3);		
	    	$('#div' + temp_divid).css({'left': $('#privatecontainer_' + temp_divid).position().left});
		});
	
	}
	
	function ModifyChatTabIndex(val) {
		chat_slider_index += val;
		SetChatTabIndex(chat_slider_index);
	}
	
	function SetChatTabIndex(val) {	
		chat_slider_index = val;
		UpdateChatTabs();
	}
	
	function LoadSpanish() {
		$("#media_iframe").html("<iframe src='http://www.streammonkey.com/iframe/2678' width='100%' height='349px' frameborder='0' allowfullscreen webkitAllowFullScreen mozAllowFullscreen></iframe>");
		
		$("#translation_english").html("<a onclick='LoadEnglish()' class='jwplayer_lang_link'>English</a>");
		$("#translation_spanish").html("<span class='jwplayer_lang_text'>Espanol</span>");
	}
	
	function LoadEnglish() {
		$("#media_iframe").html("<iframe src='http://www.streammonkey.com/iframe/2056' width='100%' height='349px' frameborder='0' allowfullscreen webkitAllowFullScreen mozAllowFullscreen></iframe>");
		
		$("#translation_english").html("<span class='jwplayer_lang_text'>English</span>");
		$("#translation_spanish").html("<a onclick='LoadSpanish()' class='jwplayer_lang_link'>Espanol</a>");
	}
	
	/*function ShowChatWindow(uid) {
		console.log("ShowChatWindow() uid: " + uid);
		var uid_tab_index; // Index # of chat tab in list	
	
		// Are there more tabs than allowed to be displayed at once?
		if (chat_tabs_open > chat_tabs_max) {
			uid_tab_index = $('#li' + uid).index('.single-chat');
			if (uid_tab_index != -1) {			
				// Tab is off the screen to the left
				if (uid_tab_index < chat_slider_index) {					
					SetChatTabIndex(uid_tab_index);
				}
				// Tab is off the screen to the right
				else if (uid_tab_index > chat_slider_index + chat_tabs_max - 1) {
					var set_chat_tab_index = chat_slider_index + chat_tabs_max - 1;
					console.log("Set Chat tab index: " + set_chat_tab_index);
					if(chat_tabs_open - set_chat_tab_index < chat_tabs_max) { 
					SetChatTabIndex(chat_tabs_open - chat_tabs_max); } // Don't let gaps appear after chat tabs if near the end of tabs						
					else { SetChatTabIndex(set_chat_tab_index); }
				}
			}
		}
		current_chat_uid = uid;
		$('.chat-tab').removeClass("tab-selected");
		$('#tab' + uid).addClass("tab-selected");
		$('#tab' + uid).removeClass("new-message");
		$(".single-chat-window").hide();
		$('#div' + uid).show();
		$('#pmsgbox' + uid).focus();
	}*/
	
	function ClosePrivateChat(chatid) {
		$("#privatecontainer_" + chatid).remove();
		if(chat_slider_index > 0) { ModifyChatTabIndex(-1); }
		UpdateChatTabs();
	}
	
	function HideChatWindows() {
		$('.single-chat-window').hide(); 
		$('.chat-tab').removeClass("tab-selected");
	}

</script>

{!-- End Node Chat --}

{!-- Google Maps Ajax --}
<!-- Google AJAX to get user Geolocation -->
<script type="text/javascript" src="http://www.google.com/jsapi"></script>

<script type="text/javascript">
var markersArray = {};
var client_location;
var client_latitude;
var client_longitude;

function UpdateClientLocation() {
	console.log("UpdateClientLocation() before: " + client_location);
	$("#profile-location").html(client_location);
	console.log("UpdateClientLocation() after: " + client_location);
	if (socket && socket.connected) {
		{if logged_in}
			socket.emit('update user', { latitude: client_latitude, longitude: client_longitude, location: client_location, groupsize: logged_in_groupsize });
		{if:else}
			socket.emit('update user', { latitude: client_latitude, longitude: client_longitude, location: client_location, groupsize: logged_in_groupsize });
		{/if}
	}
	UpdateMyUserInfo();
}

function UpdateMyUserInfo() {
	AddMarker(<?php echo $member_id_reference; ?>, client_latitude, client_longitude);
	AddUser(<?php echo $member_id_reference; ?>, client_latitude, client_longitude, client_location, "{screen_name}", logged_in_groupsize, true);
}

/*google.setOnLoadCallback(function() {
    if (google.loader.ClientLocation) {
    	console.log("Position received by google.loader.ClientLocation: latitude - " + google.loader.ClientLocation.latitude + ", longitude - " + google.loader.ClientLocation.longitude);
    	if (!client_latitude && !client_longitude) {
	    	client_latitude = google.loader.ClientLocation.latitude.toFixed(4);
			client_longitude = google.loader.ClientLocation.longitude.toFixed(4);
			
			if (google.loader.ClientLocation.address.country_code == "US") {
	    		client_location = google.loader.ClientLocation.address.city + ", " + google.loader.ClientLocation.address.region.toUpperCase();
	    		UpdateClientLocation();
	    	}
	    	else {
	    		client_location = google.loader.ClientLocation.address.city + ", " + google.loader.ClientLocation.address.country;
	    		UpdateClientLocation();
	    	}
	    	
	    	if (map) {
	    		map.panTo(new google.maps.LatLng(client_latitude, client_longitude));
	    	}		
		}
    }
    else {
	    console.log("Position not received by google.loader");
    }
});*/

function initiate_geolocation() {  
	if (navigator.geolocation) { navigator.geolocation.getCurrentPosition(handle_geolocation_query, handle_geolocation_error, {maximumAge: 600000}); }  
	$("#profile-location").html(client_location);  	
} 

function handle_geolocation_query(position){  
    client_latitude = position.coords.latitude.toFixed(4);
    client_longitude = position.coords.longitude.toFixed(4);	
        
    console.log("HTML5 Geolocation Info - Lat: " + client_latitude + ", Lng: " + client_longitude);
    $.get("/scripts/getcityfromlatlng.php/?lat=" + client_latitude + "&lng=" + client_longitude, function(data) { 
    	client_location = data;	      	 	
    	console.log("handle_geolocation_query() city: " + client_location);
    	UpdateClientLocation(); 
    });
    
    console.log("handle_geolocation_query() lat: " + client_latitude + ", lng: " + client_longitude);

    if (map) {
		map.panTo(new google.maps.LatLng(client_latitude, client_longitude));
	}
}  

function handle_geolocation_error(error) { }
 
</script>

<!-- End Google AJAX Code -->


<div id="chat-windows"></div>

<div id="chat-bar">
	<div class="container_12">	
			<div id="chat-slider-container">
			<div id="chat-left" style="display:none; cursor:pointer"><img src="{v2-image-asset-url}/onlineworship/arrow-left.png" /></div>
			<div id="chat-right" style="display:none; cursor:pointer"><img src="{v2-image-asset-url}/onlineworship/arrow-right.png" /></div>
					
			<div id="chat-tab-bar">			
				<ul id="chat-slider-ul">
				</ul>
			</div>

		</div>
		
	</div>
</div>

<div id="online-worship-bg">
	<div class="container_12">
		<h1 class="grid_4" style="text-align:center; display:none">Online Worship</h1>	
		
		<div class="clear"></div>
		
		<div id="series-box" class="container_12">
			<div class="series-box-top"></div>
			<div class="series-box-mid">
					<div id="current-series" class="grid_7">
						{exp:channel:entries channel="series" limit="1" cache="yes" refresh="120"}

							<img src="http://www.northlandchurch.net/_assets/img/v2/christmas/Christmas_2014_640x360.jpg" style="height: 140px; width: auto">
							
							<p style="margin-top: 30px">The joy of God has passed through the poverty of the manger and the torment of the cross; and so it is unconquerable, irrefutable.   <br><div style="text-align:right"><strong>Dietrich Bonhoeffer</strong></div></p>
							
						{/exp:channel:entries}
					</div>				
					
					<div id="important-links" class="grid_3">
						
						<h1>Get Connected</h1>
						<div class="clear"></div>
						<div class="series-divider"></div>
						<p>
							<a href="http://www.northlandchurch.net/new/" target="_blank">New to Northland?</a>
						</p>
						
						<p>
							<a href="http://generous.northlandchurch.net" target="_blank">Tithes & Offerings</a>
						</p>
						
						<p>
							<a href="http://www.northlandchurch.net/christmas" target="_blank">Christmas Eve Service Times</a>
						</p>
						
						<p>
							<a href="http://calendar.northlandchurch.net/" target="_blank">Upcoming Events Calendar</a>
						</p>
					</div>
					
					<div id="share-links" class="grid_2">
						<h1>Social Media</h1>
						<div class="clear"></div>
						<div class="series-divider"></div>
						<a href="http://twitter.com/share" class="twitter-share-button" data-text="Join me in worshiping at Northland Church online!" data-count="horizontal" data-via="northlandchurch">Tweet</a><script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>
						<br>
						
						<div id="fb-root"></div>
						<script>(function(d, s, id) {
						  var js, fjs = d.getElementsByTagName(s)[0];
						  if (d.getElementById(id)) return;
						  js = d.createElement(s); js.id = id;
						  js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=140933859326218";
						  fjs.parentNode.insertBefore(js, fjs);
						}(document, 'script', 'facebook-jssdk'));</script>
						
						<div class="fb-like" data-href="http://www.facebook.com/northlandchurch" data-send="false" data-layout="button_count" data-width="120" data-show-faces="true" data-colorscheme="dark" data-font="arial"></div>
						
						<div class="fb-send" data-href="http://www.northlandchurch.net/worship" data-colorscheme="dark"></div>
	
			</div>

				<div class="clear"></div>
			</div>
			<div class="series-box-btm"></div>
		</div>
		
		
		<div id="map-side-bar">
		
			<div id="people-column">
				<div id="search-bg">
					<div id="profile-box">
						{if logged_in}
						<div id="profile-avatar">
							<a href="/profile" target="_blank"><img id="profile-avatar-img" src="/images/member_photos/50x50/photo_{member_id}.jpg" onerror="this.src='/images/avatar.png'"></a>
						</div>
						<div id="profile-user">
							<div id="profile-name" class="profile-header">{exp:member:custom_profile_data}{exp:low_replace find='&' replace='and' regex='yes'}{if display_name}{display_name}{if:else}{screen_name}{/if}{/exp:low_replace}{/exp:member:custom_profile_data}</div>							
							<div id="profile-location"></div>
						</div>
						
						<div id="profile-update">
						<div id="profile-spacer"></div>
							<a href="/profile" target="_blank">Update Profile</a><br>
							<a href="/respond/pray" target="_blank">Post a Prayer</a><br>
							<a href="/respond/readthebible" target="_blank">Read the Bible</a>
						</div>
						{if:else}
						<div id='profile-notsignedin-welcome' class='profile-header'>Welcome to Northland Online Worship</div>
						<div id='profile-notsignedin-signin'><a class='user-login' href='#login-register-box'>Sign-in or Register</a> in under 30 seconds.</div>
						{/if}
					</div>
					<div class="clear"></div>					
					<div id="search-divider"></div>
					{if logged_in}
					<div id="search-box">
						<h1>Search People</h1>
						<div id="search-box-input">					
							<input id="filter-search" type="text" name="" value="" />
							<input id="filter-search-button" type="button" name="" value="" />
						</div>
					</div>	
					{/if}				
				</div>
                
				<div class="tabs">					
					<div id="filter-buttons" class="current-signedin">
						<div id="filter-nav" style="width:195px; background: none">
							{if logged_in}<div id="filter-friends"><a onclick="ShowFriends()"><span id="number-friends">0</span></a></div>{/if}
							<div id="filter-all"><a onclick="ShowEveryone()"><span id="number-all">0</span></a></div>						
							<div id="filter-signedin"><a onclick="ShowSignedIn()"><span id="number-signedin">0</span></a></div>						
							{!--<div id="filter-groups"><a onclick="ShowGroups()"><span id="number-groups">0</span></a></div>--}
						</div>
							<div id="profile-status"><div id="profile-status-img"></div></div>
					</div>
					<div class="clear"></div>
					
					<div id="filter-shadow"></div>	
					
					<div id="chat-disconnected" class="rostermessage">Chat loading...</div>		
					{if !logged_in}
<!--					<div class="rostermessage">Please <a class="user-login" href="#login-register-box" style="text-decoration:underline">login</a> to access the chatroom and communicate with other congregants.</div> -->
					<div class="rostermessage">Please <a class="user-login" href="#login-register-box" style="text-decoration:underline">login</a> to access additional features like, Request Prayer, Read the Bible and more.</div>
					{/if}	
					<div id="chatroster" class="custom_scrollbar" style="height: 750px; overflow: hidden;">		                 
	                    <div id="minister"></div> 
	                    <div id="tech-support"></div>                 
	                    <div id="people"></div>
                   	</div>

                </div>	{!-- For tab --}
			</div>
		</div>
		
			{if service_live == "true"}
			{if:else}
			<div id="push-bar" class="grid_8" style="margin: 0 0 10px 10px">
				<div class="push-bar-top"></div>
				<div class="push-bar-mid">
					<div id="push-bar-icon"></div>
					<p id="push-bar-text">
						Welcome to online worship at Northland! {exp:channel:entries channel='media' category='48' limit='1' dynamic='off' cache='yes' refresh='240'}We currently aren't in live worship, but you can watch last week's service '{title}' below.{/exp:channel:entries}
					</p>
								
					<!--<a onclick="HidePushbar()"><div class='push-bar-close'></div></a>-->
					<div class="clear"></div>
				</div>
				<div class="push-bar-btm"></div>
			</div>
			{/if}
		<div id="onlineworship-right">
			{!--<div id="onlineworshipvid">Preparing to load video...<br><br></div> --}
			
			{!-- WORSHIP VIDEO --}
			{if service_live=="true"} 
			
			<div id="media_iframe">
				<iframe src='http://www.streammonkey.com/iframe/2056' width='100%' height='349px' frameborder='0' allowfullscreen webkitAllowFullScreen mozAllowFullscreen></iframe>
			</div>
			
			{if:else}
				<div id="onlineworshipvid"></div>
				{exp:channel:entries channel="media" category="48" limit="1" dynamic="off" cache="yes" refresh="120"}
				<script type="text/javascript"> 
					jwplayer("onlineworshipvid").setup({					   
					    skin: "/jw/jw54/skins/glow/glow.zip",
					    height: 349,
					    width: 620,
					    plugins: {
					    	"gapro-2":{ accountid: "UA-966214-1", trackstarts: true, trackpercentage: true, tracktime: true},
					    	"viral-2":{onpause: false, allowmenu: true, oncomplete: false, functions: "link, embed", email_subject:"Check out this video from Northland Church", email_footer:"northlandchurch.net"}
					    	},
					    repeat: "list",
					    image: "/_img/uploads/{media-primary}",
					    modes: [{
					           type:"flash",
					    	   src: "/_assets/jwplayer/5_9/player.swf",
						       config: {
						    		file: "/media/media-main",
						    		}
					    		},
						    	{ type: "html5",
						    	  config:  {
						    	  		file: "http://video.northlandchurch.net:1935/vods3/_definst_/mp4:amazons3/nacdvideo/{entry_date format='%Y'}/{entry_date format='%y%m%d'}_service_pc.mp4/playlist.m3u8"
						    	  	}
					    	}]
						    	
					});
					</script>    
				{/exp:channel:entries}
			{/if}			
			{!-- END WORSHIP VIDEO --}
			
			<div class="clear"></div>
			<div id="below_video">
			{if service_live=="true"}

				<?php if (({current_time format="%G%i"} > 800) && ({current_time format="%G%i"} < 1600)) : ?>
					<div id="livevid-quality" class="below_videotab" style="margin-top:-5px; border: none">
						<p id="language_select"> Translation: 
							<span id="translation_english">
								<span class="jwplayer_lang_text">English</span>
							</span>
						| <span id="translation_spanish">
							<a id="jwplayer_spanish" onclick="LoadSpanish()" class="jwplayer_lang_link">Espanol</a>
							</span>
						</p>
					</div>
				<?php endif; ?>	
				
				
			
			{if:else}
				{exp:channel:entries channel="media" category="48" limit="1" dynamic="off"}
					<div id="livevid-quality" class="below_videotab" style="border: none">
						<p>Last Weekend's Message - "{title}"</p><br>
						<p><strong>LIVE:</strong> {service_times_singleline}</p>
					</div>
				{/exp:channel:entries}
			{/if}
				
				<div id="current-viewers" class="below_videotab" style="font-weight: 300; color: #b3b3b3; margin-top:-5px; border: none"></div>
			
			</div>
			
			<div class="clear"></div>
			
			{!--<div id="bible_hidden_container" style="display:none"></div>
			<div id="bible_passages" style="display:none"></div>
			<div class="clear"></div>
			<div id="bible_verses" style="display:none"></div>
			
			<div class="clear"></div>--}

			
			{!-- TABBED MAP, NOTES, GROUP CHAT, WORSHIP GUIDE --}			
			<div class="tabs">
			
			<div id="interact-tabs">
				<ul id="interact-options">
					<li id="interact-map"><a href="#map-tab" class="current-map interact-tab-bg">View Map</a></li>
					<li id="interact-notes"><a href="#notes-tab" class="current-notes interact-tab-bg">Take Notes</a></li>
					<li id="interact-chat"><a href="#chat-tab" class="current-groupchat interact-tab-bg">Group Chat</a></li>
					<li id="interact-guide"><a href="#worship-tab" class="current-guide interact-tab-bg">Worship Guide</a></li>
					<li id="interact-share"><a href="#share-tab" class="current-share interact-tab-bg">Share</a></li>
				</ul>
			</div>
			<div id="interact-tabs-shadow"></div>
			<div class="clear"></div>
			{!-- END TABBED MAP, NOTES, GROUP CHAT, WORSHIP GUIDE --}
			
			
				<div id="tabs-box">
				
					<div id="map-tab">
						<div id="map-viewer"></div>
					</div>
					
					<div id="notes-tab" style="display: none">					
						{if service_live=="true"}					
							{if logged_in}
							{exp:channel:entries dynamic="off" channel="media" orderby="date" category="58" show_future_entries="yes" sort="desc" limit="1"}
							{embed="/_component/media_notes" week="{media-week}" series="{media-series}" mediaentryid="{entry_id}" defaulttext="{if media-reference}<b>Scriptures Referenced:</b><br>{media-reference}{/if}"}							
							{/exp:channel:entries}
							{if:else}
							{exp:channel:entries dynamic="off" channel="media" orderby="date" category="58" show_future_entries="yes" sort="desc" limit="1"}
								<textarea id="notes-note" name="notes-note">
	{exp:strip_html}{media-reference}{/exp:strip_html}</textarea>
							{/exp:channel:entries}
								<a class="user-login" href="#login-register-box"><img src="/_assets/img/v2/onlineworship/btn-login-email.png" /></a>
							{/if}																
						{if:else}
							{exp:channel:entries channel="media" category="48" limit="1" dynamic="off"}
								{if logged_in}
									{embed="/_component/media_notes" week="{media-week}" series="{media-series}" mediaentryid="{entry_id}" defaulttext="{if media-reference}<b>Scriptures Referenced:</b><br>{media-reference}{/if}"}
								{if:else}
									<textarea id="notes-note" name="notes-note">Scriptures Referenced:
	{exp:strip_html}{media-reference}{/exp:strip_html}</textarea>
									<a class="user-login" href="#login-register-box"><img src="/_assets/img/v2/onlineworship/btn-login-email.png" /></a>
								{/if}
							{/exp:channel:entries}							
						{/if}
					</div>
					
					<div id="chat-tab" style="display: none">						
						<div id="chat-field-box">
						<form name="chatform" id="group_chat_form">							

							<input id="groupchat_field" type="text" name="" value=""/>								
								<input id="chat-field-box-submit" type="submit" value="" />

<!--								<div id="chat-field-box-signup">Join the discussion! <a class='user-login' href="#login-register-box">Sign-in or Register</a> in under 30 seconds.</div>	-->

							<input type="hidden" id='keevalue' name="keevalue" value="abc" >
						</form>		
						</div>
						<div>
							{if group_id == "1" || group_id == "19" || group_id == "13"}
							<div id="admin_panel" style="background-color: #DDD; padding: 10px; border-bottom: 1px solid #BBB;">
								<strong>Admin Panel</strong>
								<div style="float:right">
									<a onclick="ClearGroupChat()">Clear Group Chat</a>
								</div>
							</div>
							{/if}
                        	<ul id="chat-box-list">
                            </ul>
                        </div>

					</div>
					
					<div id="worship-tab" style="display: none; background-color: white">			
					</div>

					<div id="share-tab" style="display:none">	
					

													
						<div id="online-invite">						
							<h1>Invite Someone to Worship with You</h1>
							<form id="share_form">
               <div class='clear'></div>
                <div style="width:50%; float:left">
               	<label>Sender Name:</label>         
               	<input style="width: 160px" id="shareform_from_name" type="text" value='{if screen_name}{screen_name}{/if}'></input><br>
               	<label>Sender E-mail:</label> 
               	<input style="width: 160px" id="shareform_from_email" type="text" value='{if email}{email}{/if}'></input>
               	</div>
               	<div style="width:50%; float: left">
               	<label>Recipients Name:</label>         
               	<input style="width: 160px" id="shareform_to_name" type="text" value=''></input><br>
               	<label>Recipients E-mail:</label>         
               	<input style="width: 160px" id="shareform_to_email" type="text" value=''></input>
               	</div>
               	<label>Personal Message:</label>
                <textarea style="width: 468px; height: 135px; resize:none" id="shareform_message"></textarea>
                <div class='clear'></div>
                <input style="float:right; margin-right: 40px"name="submit" type='submit' value='Submit Form' />
							</form>
						</div>							
					</div>
				
				</div>
				
			</div>
			
			
		</div>
				
		<div class="clear"></div>
	</div>
</div>

<script src="//js.maxmind.com/js/apis/geoip2/v2.1/geoip2.js" type="text/javascript"></script>
	<script type="text/javascript">
 
	var onSuccess = function(location){
		// Only update socket if location not already set by HTML5
		console.log("MaxMind location received");
		if (!client_location) {		
			console.log("Location not set yet, setting with MaxMind location info");
			client_latitude = location.location.latitude;
			client_longitude = location.location.longitude;
			if (location.country.iso_code = "US") {
				client_location = location.city.names.en + ", " + location.subdivisions[0].names.en;
			}
			else {
				client_location = location.city.names.en + ", " + location.country.names.en;
			}	
			
			UpdateClientLocation();
		}
		else {
			console.log("Location already set, not using MaxMind location info");
		}		
	};
	 
	var onError = function(error){
		console.log("Error getting MaxMind location");
	};
	 
	geoip2.city(onSuccess, onError);
	 
	</script>

{embed="_includes/html_close"}